# .gitlab-ci.yml for The Data Packet
# Converted from GitHub Actions workflows

stages:
  - test
  - build
  - lint
  - typecheck
  - coverage
  - docs
  - docker
  - terraform
  - summary

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  PYTHON_VERSIONS: "3.10 3.11 3.12 3.13"
  HATCH_ENV: "dev"

.cache:
  cache:
    key: "$CI_JOB_NAME"
    paths:
      - .cache/pip
      - .hatch

.test_template: &test_template
  image: python:$PYTHON_VERSION
  stage: test
  before_script:
    - python -m pip install --upgrade pip
    - pip install hatch
  script:
    - echo "ðŸ” Running type checking for Python $PYTHON_VERSION"
    - hatch run dev:mypy the_data_packet
    - echo "ðŸ§ª Running tests for Python $PYTHON_VERSION"
    - mkdir -p test-results-$PYTHON_VERSION
    - hatch test -- --junit-xml=test-results-$PYTHON_VERSION/pytest.xml
    - echo "âœ… Tests completed for Python $PYTHON_VERSION"
    - echo "ðŸ“¦ Building package for Python $PYTHON_VERSION"
    - hatch build
  artifacts:
    when: always
    paths:
      - test-results-$PYTHON_VERSION/
    expire_in: 30 days

# Matrix test jobs for each Python version
.test_matrix:
  parallel:
    matrix:
      - PYTHON_VERSION: [3.10, 3.11, 3.12, 3.13]
  extends: ['.test_template', '.cache']
  script:
    - echo "ðŸ” Running type checking for Python $PYTHON_VERSION"
    - hatch run dev:mypy the_data_packet
    - echo "ðŸ§ª Running tests for Python $PYTHON_VERSION"
    - mkdir -p test-results-$PYTHON_VERSION
    - hatch test -- --junit-xml=test-results-$PYTHON_VERSION/pytest.xml
    - echo "âœ… Tests completed for Python $PYTHON_VERSION"
    - echo "ðŸ“¦ Building package for Python $PYTHON_VERSION"
    - hatch build

# Linting job
lint:
  image: python:3.11
  stage: lint
  extends: .cache
  before_script:
    - python -m pip install --upgrade pip
    - pip install hatch
    - hatch env create
    - hatch build
    - mkdir -p linting-reports
  script:
    - echo "ðŸ” **Code Formatting Checks**"
    - hatch run dev:isort ./the_data_packet --check-only --diff > linting-reports/isort-report.txt 2>&1 || true
    - hatch run dev:black ./the_data_packet --check --diff > linting-reports/black-report.txt 2>&1 || true
    - hatch run dev:flake8 ./the_data_packet > linting-reports/flake8-report.txt 2>&1 || true
  artifacts:
    when: always
    paths:
      - linting-reports/
    expire_in: 30 days

# MyPy type checking job
mypy:
  image: python:3.11
  stage: typecheck
  extends: .cache
  before_script:
    - python -m pip install --upgrade pip
    - pip install hatch
    - hatch build
    - hatch env create
    - mkdir -p mypy-reports
  script:
    - hatch run dev:mypy ./the_data_packet > mypy-reports/mypy-output.txt 2>&1 || true
    - hatch run dev:mypy ./the_data_packet --html-report mypy-reports/html/ --txt-report mypy-reports/ --linecount-report mypy-reports/ 2>/dev/null || true
  artifacts:
    when: always
    paths:
      - mypy-reports/
    expire_in: 30 days

# Unit tests with coverage
unit_tests:
  image: python:3.11
  stage: coverage
  extends: .cache
  before_script:
    - python -m pip install --upgrade pip
    - pip install hatch
    - hatch build
  script:
    - mkdir -p test-results
    - hatch run test-cov -- --junit-xml=test-results/pytest.xml --cov-report=xml --cov-report=html --cov-report=term-missing || true
  artifacts:
    when: always
    paths:
      - test-results/
      - coverage.xml
      - htmlcov/
    expire_in: 30 days

# Build summary (placeholder, can be extended for custom summary)
build_summary:
  image: python:3.11
  stage: summary
  needs:
    - test_matrix
    - lint
    - mypy
    - unit_tests
  script:
    - echo "# ðŸš€ Build Summary Report"
    - echo "See job artifacts for detailed reports."
  rules:
    - when: always

# Documentation build and deploy
docs_build:
  image: python:3.11
  stage: docs
  extends: .cache
  before_script:
    - python -m pip install --upgrade pip
    - pip install hatch
  script:
    - hatch run docs:build
    - echo "âœ… Documentation build completed successfully"
    - echo "ðŸ“š Documentation will be deployed as a GitLab Pages artifact"
  artifacts:
    paths:
      - docs/build
    expire_in: 30 days

pages:
  stage: docs
  script:
    - echo "Deploying documentation to GitLab Pages..."
  artifacts:
    paths:
      - docs/build
  only:
    - main

# Docker build and publish
docker_build:
  image: docker:24.0.5
  stage: docker
  services:
    - docker:24.0.5-dind
  variables:
    DOCKER_DRIVER: overlay2
  before_script:
    - echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
  script:
    - export VERSION="v1.0.$CI_PIPELINE_IID"
    - docker buildx create --use
    - docker buildx build --platform linux/amd64,linux/arm64 --push \
        -t "$DOCKERHUB_USERNAME/the-data-packet:latest" \
        -t "$DOCKERHUB_USERNAME/the-data-packet:$VERSION" .
    - echo "ðŸš€ Successfully deployed multi-platform Docker image with tags:"
    - echo "- $DOCKERHUB_USERNAME/the-data-packet:latest"
    - echo "- $DOCKERHUB_USERNAME/the-data-packet:$VERSION"
    - echo "- SHA-based tag for this commit"
    - echo "ðŸ“± Supported platforms: linux/amd64, linux/arm64"
  only:
    - main

# Terraform deploy
terraform_deploy:
  image:
    name: hashicorp/terraform:1.6.0
    entrypoint: [""]
  stage: terraform
  variables:
    AWS_REGION: "us-west-2"
  before_script:
    - apk add --no-cache python3 py3-pip git
    - pip3 install awscli
    - export AWS_ACCESS_KEY_ID="$AWS_ACCESS_KEY_ID"
    - export AWS_SECRET_ACCESS_KEY="$AWS_SECRET_ACCESS_KEY"
    - export AWS_DEFAULT_REGION="$AWS_REGION"
    - cd infra
  script:
    - terraform init
    - terraform validate
    - |
      if aws s3 ls "s3://the-data-packet" 2>/dev/null; then
        echo "Bucket exists, importing to state..."
        terraform import aws_s3_bucket.data_packet_bucket the-data-packet || echo "Bucket already in state or import failed"
        terraform import aws_s3_bucket_public_access_block.data_packet_bucket_pab the-data-packet || echo "PAB already in state or import failed"
        terraform import aws_s3_bucket_policy.data_packet_bucket_policy the-data-packet || echo "Policy already in state or import failed"
      fi
    - terraform plan -out=tfplan
    - terraform apply -auto-approve tfplan
  only:
    - main
  dependencies:
    - docker_build
