name: Python Build and Terraform Deploy

on:
    workflow_run:
        workflows: ["Build and Publish Docker Image"]
        types:
            - completed

env:
    PYTHON_VERSION: "3.11"
    TERRAFORM_VERSION: "1.6.0"

jobs:
    readiness-test:
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            - name: Set up Python ${{ env.PYTHON_VERSION }}
              uses: actions/setup-python@v4
              with:
                  python-version: ${{ env.PYTHON_VERSION }}

            - name: Cache pip dependencies
              uses: actions/cache@v3
              with:
                  path: ~/.cache/pip
                  key: ${{ runner.os }}-pip-${{ hashFiles('**/pyproject.toml') }}
                  restore-keys: |
                      ${{ runner.os }}-pip-

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install build pytest pytest-cov
                  pip install -e .

            - name: Run tests with detailed reporting
              run: |
                  echo "ðŸ§ª **Readiness Test Results**" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY

                  mkdir -p readiness-test-results
                  pytest tests/ --cov=the_data_packet --cov-report=xml --cov-report=html --cov-report=term-missing --junit-xml=readiness-test-results/pytest.xml
                  # Parse and display test results
                  if [ -f readiness-test-results/pytest.xml ]; then
                    python3 << 'EOF'
                  import xml.etree.ElementTree as ET
                  import os

                  try:
                      tree = ET.parse('readiness-test-results/pytest.xml')
                      root = tree.getroot()
                      testsuite = root.find('testsuite')
                      
                      if testsuite is not None:
                          tests = testsuite.get('tests', '0')
                          failures = testsuite.get('failures', '0') 
                          errors = testsuite.get('errors', '0')
                          time = testsuite.get('time', '0')
                          
                          passed = int(tests) - int(failures) - int(errors)
                          
                          with open(os.environ['GITHUB_STEP_SUMMARY'], 'a') as f:
                              f.write(f"ðŸ“Š **Test Summary:**\n")
                              f.write(f"- âœ… Passed: {passed}\n")
                              f.write(f"- âŒ Failed: {failures}\n")
                              f.write(f"- âš ï¸ Errors: {errors}\n")
                              f.write(f"- ðŸ•’ Time: {time}s\n")
                              f.write(f"\n")
                              
                              if int(failures) + int(errors) == 0:
                                  f.write("ðŸŽ‰ **All readiness tests passed!**\n")
                              else:
                                  f.write("âŒ **Readiness tests failed**\n")
                  except Exception as e:
                      with open(os.environ['GITHUB_STEP_SUMMARY'], 'a') as f:
                          f.write(f"âŒ Could not parse test results: {e}\n")
                  EOF
                  fi

                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "ðŸ“Š **Coverage Summary:**" >> $GITHUB_STEP_SUMMARY
                  if [ -f coverage.xml ]; then
                    python3 << 'EOF'
                  import xml.etree.ElementTree as ET
                  import os

                  try:
                      tree = ET.parse('coverage.xml')
                      root = tree.getroot()
                      line_rate = float(root.get('line-rate', 0)) * 100
                      
                      with open(os.environ['GITHUB_STEP_SUMMARY'], 'a') as f:
                          f.write(f"ðŸ“ˆ Overall Coverage: {line_rate:.1f}%\n")
                          if line_rate >= 80:
                              f.write("âœ… Good coverage level\n")
                          else:
                              f.write("âš ï¸ Coverage could be improved\n")
                  except:
                      pass
                  EOF
                  fi

            - name: Build package
              run: |
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "ðŸ“¦ **Package Build**" >> $GITHUB_STEP_SUMMARY
                  python -m build
                  echo "âœ… Package built successfully" >> $GITHUB_STEP_SUMMARY

            - name: Upload readiness test artifacts
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: readiness-test-results
                  path: |
                      readiness-test-results/
                      coverage.xml
                      htmlcov/
                  retention-days: 30

    terraform-deploy:
        needs: readiness-test
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: ./infra
        steps:
            - uses: actions/checkout@v4
            - name: Set up GCP credentials
              run: |
                  echo "$GCP_SERVICE_ACCOUNT_KEY" > gcp-key.json
              env:
                GCP_SERVICE_ACCOUNT_KEY: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
            - name: Set GOOGLE_APPLICATION_CREDENTIALS env
              run: echo "GOOGLE_APPLICATION_CREDENTIALS=$(pwd)/gcp-key.json" >> $GITHUB_ENV
            - name: Setup Terraform
              uses: hashicorp/setup-terraform@v3
              with:
                terraform_version: ${{ env.TERRAFORM_VERSION }}
            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                aws-region: us-west-2
            - name: Terraform Init
              run: terraform init
            - name: Terraform Validate
              run: terraform validate
            - name: Import existing resources if they exist
              run: |
                # Try to import existing S3 bucket if it exists
                if aws s3 ls "s3://the-data-packet" 2>/dev/null; then
                    echo "Bucket exists, importing to state..."
                    terraform import aws_s3_bucket.data_packet_bucket the-data-packet || echo "Bucket already in state or import failed"
                    terraform import aws_s3_bucket_public_access_block.data_packet_bucket_pab the-data-packet || echo "PAB already in state or import failed"
                    terraform import aws_s3_bucket_policy.data_packet_bucket_policy the-data-packet || echo "Policy already in state or import failed"
                fi

                # Try to import existing GCP resources if they exist
                # Import GCP Storage Bucket if it exists
                if gsutil ls -b "gs://audio_bucket" 2>/dev/null; then
                    echo "GCP bucket exists, importing to state..."
                    terraform import google_storage_bucket.audio_bucket audio_bucket || echo "Bucket already in state or import failed"
                fi

                # Import GCP Service Account if it exists
                if gcloud iam service-accounts list --project=${{ secrets.GCP_PROJECT_ID }} --filter="email:data-packet-service@${{ secrets.GCP_PROJECT_ID }}.iam.gserviceaccount.com" --format="value(email)" | grep -q "data-packet-service@${{ secrets.GCP_PROJECT_ID }}.iam.gserviceaccount.com"; then
                  echo "GCP service account exists, importing to state..."
                  terraform import google_service_account.data_packet_sa projects/${{ secrets.GCP_PROJECT_ID }}/serviceAccounts/data-packet-service@${{ secrets.GCP_PROJECT_ID }}.iam.gserviceaccount.com || echo "Service account already in state or import failed"
                fi
            - name: Terraform Plan
              run: terraform plan -out=tfplan
            - name: Terraform Apply
              run: terraform apply -auto-approve tfplan
